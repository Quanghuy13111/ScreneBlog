{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}Đăng ký tài khoản{% endblock %}

{% block content %}
<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow-lg border-0 rounded-lg">
                <div class="card-header bg-primary text-white text-center">
                    <h3 class="my-4">Tạo tài khoản mới</h3>
                </div>
                <div class="card-body p-5">
                    
                    <!-- Vùng hiển thị lỗi chung -->
                    <div id="form-errors" class="alert alert-danger d-none" role="alert"></div>

                    <form id="signup-form" method="POST" action="{% url 'signup' %}" novalidate>
                        {% csrf_token %}
                        
                        {{ form|crispy }}

                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                Đăng ký
                            </button>
                        </div>
                    </form>
                </div>
                <div class="card-footer text-center py-3">
                    <div class="small">
                        <a href="{% url 'login' %}">Đã có tài khoản? Đăng nhập ngay</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    body {
        background-color: #f8f9fa;
    }
    .card {
        transition: all 0.3s;
    }
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 1rem 3rem rgba(0,0,0,.175)!important;
    }
    /* CSS để hiển thị lỗi dưới trường input */
    .invalid-feedback {
        display: block;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('signup-form');
    const submitButton = form.querySelector('button[type="submit"]');
    const spinner = submitButton.querySelector('.spinner-border');
    const formErrorsDiv = document.getElementById('form-errors');

    form.addEventListener('submit', function(event) {
        event.preventDefault(); // Ngăn form submit theo cách truyền thống

        // Hiển thị spinner và vô hiệu hóa nút
        spinner.classList.remove('d-none');
        submitButton.disabled = true;

        // Xóa các lỗi cũ
        formErrorsDiv.classList.add('d-none');
        formErrorsDiv.innerHTML = '';
        document.querySelectorAll('.invalid-feedback').forEach(el => el.remove());
        document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));

        const formData = new FormData(form);

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest', // Báo cho Django biết đây là AJAX
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Đăng ký thành công, chuyển hướng đến trang đăng nhập
                window.location.href = data.redirect_url;
            } else if (data.status === 'error') {
                // Xử lý lỗi validation từ server
                const errors = data.errors;
                for (const field in errors) {
                    const errorList = errors[field];
                    const fieldInput = document.getElementById(`id_${field}`);
                    
                    if (fieldInput) {
                        fieldInput.classList.add('is-invalid');
                        const errorContainer = document.createElement('div');
                        errorContainer.className = 'invalid-feedback';
                        errorContainer.innerHTML = errorList.map(e => e.message || e).join('<br>');
                        fieldInput.parentNode.appendChild(errorContainer);
                    } else if (field === '__all__') {
                        // Lỗi chung không thuộc về trường nào cụ thể
                        formErrorsDiv.innerHTML = errorList.map(e => e.message || e).join('<br>');
                        formErrorsDiv.classList.remove('d-none');
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            formErrorsDiv.textContent = 'An unexpected error occurred. Please try again.';
            formErrorsDiv.classList.remove('d-none');
        })
        .finally(() => {
            // Ẩn spinner và kích hoạt lại nút
            spinner.classList.add('d-none');
            submitButton.disabled = false;
        });
    });
});
</script>
{% endblock %}